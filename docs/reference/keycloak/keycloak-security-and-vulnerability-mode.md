# KeyCloak Security and Vulnerability Mode
## Security Settings and Educational Attack Demonstrations

> *"Security is like quantum mechanics - the act of observing a vulnerability changes its behavior."*

---

## Overview

This document specifies security configurations, vulnerability mode features, and educational attack demonstrations for the OAuth2/OIDC tool.

**Target**: Claude Code implementing security features and vulnerability mode  
**Related Docs**: `keycloak-realm-configuration.md`, `oauth2-oidc-threat-model.md`

---

## Security Configuration

### Current Security Posture (Development Mode)

⚠️ **INTENTIONALLY WEAKENED FOR DEMO**

| Security Feature | Demo Setting | Production Setting |
|------------------|--------------|-------------------|
| HTTPS | ❌ Disabled (HTTP only) | ✅ **REQUIRED** |
| Admin Password | `admin` (public) | Strong, unique |
| Client Secrets | Weak, documented | 32+ random chars |
| Brute Force Protection | ❌ Disabled | ✅ Enabled |
| Email Verification | ❌ Disabled | ✅ Enabled |
| Token Lifespans | Short (5 min) | Application-specific |
| Redirect URI Validation | Varies by client | Exact matching |
| PKCE Enforcement | Varies by client | Required for public |

### Security Defenses Configuration

**Realm Settings → Security Defenses**

```json
{
  "bruteForceProtected": false,
  "permanentLockout": false,
  "maxFailureWaitSeconds": 900,
  "minimumQuickLoginWaitSeconds": 60,
  "waitIncrementSeconds": 60,
  "quickLoginCheckMilliSeconds": 1000,
  "maxDeltaTimeSeconds": 43200,
  "failureFactor": 30,
  
  "headers": {
    "xFrameOptions": "SAMEORIGIN",
    "contentSecurityPolicy": "frame-src 'self'; frame-ancestors 'self'; object-src 'none';",
    "xContentTypeOptions": "nosniff",
    "xXSSProtection": "1; mode=block"
  }
}
```

**Key Points**:
- Brute force protection disabled (allows testing multiple failures)
- X-Frame-Options prevents clickjacking
- Content Security Policy restricts framing
- No HSTS (HTTP only in demo)

---

## Vulnerability Mode

### Purpose

**Goal**: Educational demonstration of OAuth2/OIDC security vulnerabilities

**Use Cases**:
- Security training workshops
- Demonstrating attack vectors
- Showing why security best practices matter
- Before/after security comparisons

### Vulnerable Client Configuration

**Client ID**: `vulnerable-client`

**Intentional Vulnerabilities**:

1. **Missing PKCE Enforcement**
   - Attack: Authorization code interception
   - Config: `pkce.code.challenge.method = ""` (not enforced)

2. **Overly Permissive Redirect URIs**
   - Attack: Open redirect, authorization code theft
   - Config: `http://localhost:3000/*` (wildcard)
   - Config: `http://attacker.example.com/steal` (attacker domain)

3. **Weak Client Secret**
   - Attack: Secret compromise via brute force/guessing
   - Config: `secret = "weak-secret"` (only 11 characters)

4. **Wildcard CORS**
   - Attack: Cross-origin token theft
   - Config: `webOrigins = ["*"]` (allows any origin)

5. **All Flows Enabled**
   - Attack: Multiple attack surfaces
   - Config: Standard flow, implicit flow, direct grant all enabled

---

## Vulnerability Demonstrations

### Vulnerability 1: Authorization Code Interception (No PKCE)

**Threat Model Reference**: `oauth2-oidc-threat-model.md` Section 4.5

**Attack Scenario**:

```
1. User (Alice) initiates authorization with vulnerable-client
   URL: /auth?client_id=vulnerable-client&redirect_uri=...&response_type=code
   (No code_challenge parameter)

2. Authorization server redirects back with code:
   http://localhost:3000/vuln/callback?code=AUTHORIZATION_CODE

3. Attacker intercepts code (network sniffing, browser history, etc.)

4. Attacker exchanges code for tokens:
   POST /token
   code=AUTHORIZATION_CODE
   client_id=vulnerable-client
   client_secret=weak-secret
   (No code_verifier required)

5. Attack succeeds - attacker obtains victim's access token
```

**Tool Demonstration**:

**Step 1**: Show flow WITHOUT PKCE (vulnerable-client)
- Display: "VULNERABILITY MODE: PKCE Disabled"
- Execute authorization code flow
- Highlight: Code can be exchanged without verifier
- Show: Simulated attacker successfully exchanges code

**Step 2**: Show flow WITH PKCE (spa-client)
- Display: "SECURE MODE: PKCE Enforced"
- Execute authorization code flow with PKCE
- Highlight: Code exchange requires matching verifier
- Show: Simulated attacker fails (invalid_grant error)

**UI Requirements**:
```
╔═══════════════════════════════════════════════════════════╗
║      VULNERABILITY DEMONSTRATION: Code Interception      ║
╠═══════════════════════════════════════════════════════════╣
║                                                           ║
║  Scenario: Attacker intercepts authorization code       ║
║                                                           ║
║  WITHOUT PKCE (vulnerable-client):                       ║
║  1. Authorization code issued                            ║
║  2. Code intercepted by attacker                         ║
║  3. Attacker exchanges code → ✅ Success                ║
║  4. Attacker obtains victim's access token               ║
║                                                           ║
║  WITH PKCE (spa-client):                                 ║
║  1. Authorization code issued (bound to code_challenge)  ║
║  2. Code intercepted by attacker                         ║
║  3. Attacker attempts exchange → ❌ Fails                ║
║  4. Error: invalid_grant (code_verifier mismatch)        ║
║                                                           ║
║  Mitigation: Always use PKCE for public clients         ║
║  Reference: RFC 7636, Security BCP Section 4.5           ║
╚═══════════════════════════════════════════════════════════╝
```

**Tool Implementation Requirements**:
- Toggle: Enable/Disable PKCE
- Visualization: Show code_challenge and code_verifier flow
- Simulation: "Attacker" component that attempts code exchange
- Comparison: Side-by-side secure vs vulnerable

---

### Vulnerability 2: Open Redirect Attack

**Threat Model Reference**: `oauth2-oidc-threat-model.md` Section 4.1

**Attack Scenario**:

```
1. Attacker crafts malicious authorization URL:
   /auth?client_id=vulnerable-client
        &redirect_uri=http://attacker.example.com/steal
        &response_type=code&...

2. Victim clicks link, authenticates

3. Authorization server checks redirect_uri against registered URIs
   Registered: ["http://localhost:3000/*", "http://attacker.example.com/steal"]
   Requested: "http://attacker.example.com/steal"
   Match: YES (explicitly registered) → Allowed

4. Authorization code sent to attacker's domain:
   http://attacker.example.com/steal?code=AUTHORIZATION_CODE

5. Attacker captures code, exchanges for tokens
```

**Tool Demonstration**:

**Step 1**: Show VULNERABLE configuration (vulnerable-client)
- Registered URIs include attacker domain
- Authorization request with attacker redirect_uri
- KeyCloak allows redirect
- Show authorization code leaked to attacker

**Step 2**: Show SECURE configuration (web-app, spa-client)
- Only localhost URIs registered
- Authorization request with attacker redirect_uri
- KeyCloak rejects with `invalid_redirect_uri` error
- Show error page

**UI Requirements**:
```
╔═══════════════════════════════════════════════════════════╗
║      VULNERABILITY DEMONSTRATION: Open Redirect          ║
╠═══════════════════════════════════════════════════════════╣
║                                                           ║
║  Registered Redirect URIs (vulnerable-client):           ║
║  • http://localhost:3000/vuln/callback                   ║
║  • http://localhost:3000/*           ← Wildcard!         ║
║  • http://attacker.example.com/steal ← Attacker domain! ║
║                                                           ║
║  Attack:                                                 ║
║  1. Attacker crafts URL with malicious redirect_uri     ║
║  2. Victim authenticates                                 ║
║  3. Authorization code sent to attacker domain           ║
║  4. Attacker captures code → Attack succeeds ✅          ║
║                                                           ║
║  Secure Configuration (web-app):                         ║
║  • http://localhost:3000/callback (exact match only)     ║
║  • http://localhost:3000/oauth2/callback                 ║
║                                                           ║
║  Same Attack:                                            ║
║  1. Attacker crafts URL with malicious redirect_uri     ║
║  2. Victim authenticates                                 ║
║  3. KeyCloak rejects: invalid_redirect_uri               ║
║  4. No code issued → Attack fails ❌                     ║
║                                                           ║
║  Mitigation: Use exact redirect URI matching only       ║
║  Reference: Security BCP Section 4.1                     ║
╚═══════════════════════════════════════════════════════════╝
```

**Tool Implementation Requirements**:
- Display registered redirect URIs for selected client
- Allow user to craft authorization URL with custom redirect_uri
- Show KeyCloak response (allow/reject)
- Explain exact matching vs pattern matching
- Reference: `redirect-uri-validation.md`

---

### Vulnerability 3: Weak Client Secret

**Attack Scenario**:

```
Secret: "weak-secret" (only 11 characters, dictionary word)

Attack Methods:
1. Dictionary attack
2. Brute force (small keyspace)
3. Social engineering / guessing
4. Credential stuffing

Once compromised:
- Attacker can authenticate as client
- Exchange authorization codes
- Access protected resources
- Impersonate the application
```

**Tool Demonstration**:

**Simulation**:
1. Display weak secret: `weak-secret`
2. Show dictionary attack: Check common passwords
3. Match found in <1 second
4. Show attacker using compromised secret to obtain tokens

**Comparison**:
- Weak: `weak-secret` (11 chars)
- Strong: `xK8vN2mP9qL4wE7jR5tY3uI0oP8hG6fD1sA2` (32+ random chars)

**Tool Implementation Requirements**:
- Display client secrets (with warning)
- Calculate entropy/strength
- Simulate dictionary/brute force attack
- Show time to crack
- Recommendations for strong secrets

---

### Vulnerability 4: Wildcard CORS (Cross-Origin Token Theft)

**Attack Scenario**:

```
Configuration: webOrigins = ["*"] (allows any origin)

1. Victim visits attacker's website: evil.com

2. evil.com JavaScript makes AJAX request to token endpoint:
   fetch('http://localhost:8080/realms/oauth2-demo/protocol/openid-connect/token', {
     method: 'POST',
     credentials: 'include',  // Include cookies
     body: ...
   })

3. Browser sends request with victim's session cookie

4. Due to wildcard CORS, KeyCloak allows cross-origin request

5. Response (with tokens) sent back to evil.com JavaScript

6. Attacker steals tokens
```

**Tool Demonstration**:

**Visual**:
```
[Victim Browser]
  |
  |-- Tab 1: legitimate-app.com (authenticated)
  |
  |-- Tab 2: evil.com
       |
       |-- JavaScript makes request to KeyCloak
       |-- CORS: Access-Control-Allow-Origin: *
       |-- Tokens leaked to evil.com ❌
```

**Tool Implementation Requirements**:
- Show webOrigins configuration
- Explain wildcard CORS risk
- Simulate cross-origin request
- Show browser CORS preflight
- Compare: Wildcard (*) vs specific origin

---

### Vulnerability 5: Deprecated Flows (Implicit & Password Grant)

**Threat Model Reference**: `oauth2-oidc-threat-model.md` Sections 2.1.2, 2.4

#### Implicit Flow Vulnerabilities

**Issues**:
1. Access token in URL fragment (browser history leak)
2. No client authentication
3. No refresh tokens
4. Token leakage via HTTP Referer header
5. Cannot use PKCE

**Tool Demonstration**:

**Show Implicit Flow** (legacy-implicit client):
```
Authorization Request:
  response_type=token id_token

Redirect with tokens in fragment:
  #access_token=eyJhbGc...&token_type=Bearer&expires_in=300

Highlight Vulnerabilities:
  ❌ Tokens visible in browser history
  ❌ Tokens logged in server access logs (Referer header)
  ❌ Tokens leaked to third-party scripts
  ❌ No client authentication → Anyone can impersonate client
```

**Compare with Authorization Code + PKCE**:
```
  ✅ No tokens in URL
  ✅ Client authentication (if confidential)
  ✅ PKCE prevents code interception
  ✅ Refresh tokens supported
```

#### Resource Owner Password Credentials (ROPC) Vulnerabilities

**Issues**:
1. User credentials exposed to client
2. Defeats OAuth's purpose (delegated authorization)
3. No consent screen
4. Phishing risk
5. MFA difficult to implement

**Tool Demonstration**:

**Show Password Grant** (vulnerable-client with direct grant enabled):
```
Token Request:
  POST /token
  grant_type=password
  username=alice
  password=Password123!  ← USER CREDENTIALS IN CLIENT!
  client_id=vulnerable-client
  client_secret=weak-secret

Issues:
  ❌ Client sees user's password
  ❌ User must trust client completely
  ❌ Client could log/store credentials
  ❌ Phishing risk (fake clients)
```

**Compare with Authorization Code**:
```
  ✅ User never shares password with client
  ✅ User authenticates directly with IdP
  ✅ Consent screen shows requested permissions
  ✅ MFA and advanced auth flows supported
```

---

## Vulnerability Mode UI Implementation

### Mode Toggle

**UI Component**: Checkbox or toggle switch

```
┌─────────────────────────────────────────────────────────┐
│  Vulnerability Mode                                     │
├─────────────────────────────────────────────────────────┤
│  [●] Enable Vulnerability Demonstrations                │
│                                                          │
│  When enabled:                                          │
│  • vulnerable-client becomes selectable                 │
│  • Security vulnerabilities are highlighted             │
│  • Attack simulations available                         │
│  • Comparison with secure configurations shown          │
│                                                          │
│  ⚠️  For educational purposes only                      │
│  Do not use vulnerable configurations in production     │
└─────────────────────────────────────────────────────────┘
```

### Vulnerability Selection

**When vulnerability mode enabled**:

```
┌─────────────────────────────────────────────────────────┐
│  Select Vulnerability to Demonstrate                    │
├─────────────────────────────────────────────────────────┤
│  ○ Authorization Code Interception (No PKCE)            │
│  ○ Open Redirect Attack                                 │
│  ○ Weak Client Secret Compromise                        │
│  ○ Wildcard CORS Token Theft                            │
│  ○ Implicit Flow Vulnerabilities (DEPRECATED)           │
│  ○ Password Grant Issues (DEPRECATED)                   │
└─────────────────────────────────────────────────────────┘
```

### Demonstration Flow

For each vulnerability:

1. **Explain Vulnerability**
   - What is the security issue?
   - Why is it a problem?
   - Real-world impact

2. **Show Vulnerable Configuration**
   - Display relevant settings
   - Highlight problematic configuration

3. **Execute Attack Simulation**
   - Step-by-step attack walkthrough
   - Visual indicators of attack progress
   - Show attacker perspective

4. **Show Secure Configuration**
   - Display proper settings
   - Explain defensive measures

5. **Re-execute with Security**
   - Show attack failing
   - Explain why mitigation works

6. **Provide References**
   - Link to relevant RFC/BCP section
   - Link to threat model documentation
   - Link to implementation guide

---

## Security Warnings

### Prominent Warnings Required

**When vulnerable-client selected**:
```
╔═══════════════════════════════════════════════════════════╗
║  ⚠️  VULNERABLE CLIENT SELECTED  ⚠️                       ║
╠═══════════════════════════════════════════════════════════╣
║  This client has INTENTIONALLY INSECURE configuration.   ║
║  It is used for educational security demonstrations.     ║
║                                                           ║
║  Active Vulnerabilities:                                 ║
║  • PKCE not enforced (code interception possible)        ║
║  • Wildcard redirect URIs (open redirect)                ║
║  • Weak client secret (easily compromised)               ║
║  • Wildcard CORS (token theft possible)                  ║
║                                                           ║
║  NEVER use this configuration in production!             ║
╚═══════════════════════════════════════════════════════════╝
```

**When legacy-implicit selected**:
```
╔═══════════════════════════════════════════════════════════╗
║  ⚠️  DEPRECATED FLOW - IMPLICIT GRANT  ⚠️                 ║
╠═══════════════════════════════════════════════════════════╣
║  The Implicit Flow is DEPRECATED and should NOT be used. ║
║                                                           ║
║  Security Issues:                                        ║
║  • Tokens in URL fragment (browser history leak)         ║
║  • No client authentication                              ║
║  • Token leakage via HTTP Referer header                 ║
║  • Cannot use PKCE                                        ║
║                                                           ║
║  Use Authorization Code Flow + PKCE instead.             ║
║  Reference: OAuth 2.0 Security BCP Section 2.1.2         ║
╚═══════════════════════════════════════════════════════════╝
```

### Security Checklist Display

**When user configures a flow**, display security checklist:

```
Security Checklist for Authorization Code Flow:

Client: web-app
✅ PKCE enabled (code_challenge present)
✅ State parameter present (CSRF protection)
✅ Redirect URI exact match
✅ Client secret required
✅ HTTPS (in production)
⚠️  Token lifespan: 5 minutes (consider longer for production)

Overall Security: GOOD
```

---

## Integration with Threat Model

### Cross-References

Each vulnerability demonstration should link to:

1. **Threat Model Document**: `oauth2-oidc-threat-model.md`
   - Specific threat section
   - Attack vector details
   - Mitigation strategies

2. **Security BCP Document**: `security-best-current-practice.md`
   - Relevant BCP section
   - Current recommendations
   - Implementation guidance

3. **Implementation Guides**:
   - `pkce-implementation.md`
   - `state-parameter-and-csrf.md`
   - `redirect-uri-validation.md`

### Threat-to-Vulnerability Mapping

| Threat (from Threat Model) | Vulnerability Mode Demo | Client Used |
|-----------------------------|-------------------------|-------------|
| Authorization Code Interception | Demo 1: No PKCE | vulnerable-client |
| Open Redirect | Demo 2: Wildcard redirect_uri | vulnerable-client |
| CSRF Attack | (Not in vulnerability mode) | Use state parameter docs |
| Token Theft (Bearer) | (Future: DPoP demo) | TBD |
| Code Injection | Demo 1: No PKCE | vulnerable-client |
| Token Leakage via Referer | Demo 5: Implicit Flow | legacy-implicit |
| Client Impersonation | Demo 3: Weak Secret | vulnerable-client |

---

## Tool Implementation Checklist

### Required Features

- [ ] Vulnerability mode toggle in UI
- [ ] Vulnerability selection menu
- [ ] Vulnerable-client configuration display
- [ ] Attack simulation engine
- [ ] Side-by-side comparison (vulnerable vs secure)
- [ ] Security warnings (prominent, clear)
- [ ] Threat model cross-references
- [ ] Educational explanations for each vulnerability
- [ ] Step-by-step attack walkthrough
- [ ] Mitigation demonstration
- [ ] Security checklist display
- [ ] Deprecation warnings for implicit/password flows

### UI Components

1. **Vulnerability Mode Toggle**: Global setting
2. **Client Selector**: Show vulnerability warnings when vulnerable-client selected
3. **Demonstration Selector**: Choose which vulnerability to demonstrate
4. **Attack Simulator**: Visual step-by-step attack
5. **Comparison View**: Split screen secure vs vulnerable
6. **Warning Banners**: Context-sensitive security warnings
7. **Security Checklist**: Current configuration assessment
8. **Documentation Links**: In-context help

---

## Educational Content Requirements

### For Each Vulnerability

**Provide**:
1. **Plain English Explanation**
   - What is the vulnerability?
   - Why does it exist?
   
2. **Real-World Impact**
   - What could an attacker do?
   - What's at risk?

3. **Attack Demonstration**
   - Step-by-step walkthrough
   - Visual indicators

4. **Mitigation**
   - How to prevent the attack
   - Best practices

5. **References**
   - RFC/BCP citations
   - Threat model sections
   - Implementation guides

### Tone

- **Educational**, not alarmist
- **Practical**, with actionable advice
- **Accurate**, citing specifications
- **Encouraging**, toward secure implementations

---

## Document Metadata

| Property | Value |
|----------|-------|
| **Version** | 1.0.0 |
| **Related Docs** | `oauth2-oidc-threat-model.md`, `pkce-implementation.md`, `security-best-current-practice.md` |
| **Target** | Claude Code (implementation) |

---

**Next**: See `keycloak-integration-requirements.md` for tool-to-KeyCloak communication requirements.
