/**
 * Vulnerability Toggle Metadata Types
 *
 * Provides detailed metadata for each vulnerability toggle including
 * descriptions, severity, attack vectors, and mitigations.
 *
 * MVP: Only DISABLE_PKCE metadata is fully populated
 * Phase 2-3: Additional toggle metadata will be added
 *
 * @module vulnerability/vulnerability-toggle
 */

import { VulnerabilityCategory } from './vulnerability-category';
import { VulnerabilityToggles } from './vulnerability-config';

/**
 * Vulnerability Toggle Metadata
 *
 * Comprehensive metadata for a single vulnerability toggle.
 * Used for educational display and security assessment.
 *
 * @example
 * ```typescript
 * const metadata: VulnerabilityToggleMetadata = {
 *   key: 'DISABLE_PKCE',
 *   name: 'Disable PKCE',
 *   description: 'Removes Proof Key for Code Exchange protection...',
 *   category: VulnerabilityCategory.AUTHORIZATION_ENDPOINT,
 *   severity: 'critical',
 *   rfcReferences: ['RFC 7636', 'OAuth 2.1 Section 4.1'],
 *   attackVector: 'Authorization code interception attack...',
 *   mitigation: 'Always use PKCE (RFC 7636)...',
 *   phase: 'mvp',
 *   implemented: true,
 *   demoScenario: 'Intercept authorization code without PKCE'
 * };
 * ```
 */
export interface VulnerabilityToggleMetadata {
  /**
   * Toggle key identifier
   *
   * Must match a key in VulnerabilityToggles interface
   */
  key: keyof VulnerabilityToggles;

  /**
   * Human-readable toggle name
   *
   * Used in UI for display
   * Example: 'Disable PKCE', 'Skip State Verification'
   */
  name: string;

  /**
   * Detailed description of what this toggle does
   *
   * Explains:
   * - What security mechanism is disabled
   * - Why it's normally required
   * - What becomes possible when disabled
   */
  description: string;

  /**
   * Category this vulnerability belongs to
   *
   * Groups related vulnerabilities for organized display
   */
  category: VulnerabilityCategory;

  /**
   * Severity level of this vulnerability
   *
   * - critical: Immediately exploitable, high impact
   * - high: Serious security risk
   * - medium: Moderate risk
   * - low: Minor security issue
   */
  severity: 'critical' | 'high' | 'medium' | 'low';

  /**
   * RFC/specification references
   *
   * Points to relevant sections in OAuth2/OIDC specifications
   * Example: ['RFC 7636 Section 4', 'OAuth 2.1 Section 4.1']
   */
  rfcReferences: string[];

  /**
   * Attack vector description
   *
   * Explains how an attacker would exploit this vulnerability:
   * - Attack prerequisites
   * - Attack steps
   * - Attack impact
   */
  attackVector: string;

  /**
   * Mitigation strategy
   *
   * Explains how to defend against this attack:
   * - Required security controls
   * - Configuration recommendations
   * - Best practices
   */
  mitigation: string;

  /**
   * Implementation phase
   *
   * - mvp: Functional in MVP release
   * - phase-2: Implemented in Phase 2
   * - phase-3: Implemented in Phase 3
   */
  phase: 'mvp' | 'phase-2' | 'phase-3';

  /**
   * Whether this toggle is currently functional
   *
   * true: Toggle affects flow behavior
   * false: Toggle defined but not yet implemented
   */
  implemented: boolean;

  /**
   * Suggested demo scenario (optional)
   *
   * Step-by-step demonstration of the vulnerability
   * Used for educational purposes
   */
  demoScenario?: string;
}

/**
 * Vulnerability Metadata Registry
 *
 * Maps vulnerability toggle keys to their metadata.
 *
 * MVP: Only DISABLE_PKCE is fully populated
 * Phase 2-3: Additional metadata will be added as toggles are implemented
 */
export const VULNERABILITY_METADATA: Partial<Record<keyof VulnerabilityToggles, VulnerabilityToggleMetadata>> = {
  // ========================================================================
  // MVP - DISABLE_PKCE (fully implemented)
  // ========================================================================
  DISABLE_PKCE: {
    key: 'DISABLE_PKCE',
    name: 'Disable PKCE',
    description:
      'Removes Proof Key for Code Exchange (PKCE) protection from the authorization code flow. ' +
      'PKCE is a critical security extension that prevents authorization code interception attacks. ' +
      'When disabled, authorization codes can be intercepted and exchanged for access tokens by attackers.',
    category: VulnerabilityCategory.AUTHORIZATION_ENDPOINT,
    severity: 'critical',
    rfcReferences: [
      'RFC 7636 - Proof Key for Code Exchange',
      'RFC 7636 Section 1 - Introduction',
      'RFC 7636 Section 4 - Protocol',
      'OAuth 2.1 Section 4.1 - Authorization Code Grant (PKCE Required)',
      'RFC 6819 Section 4.4.1.1 - Threat: Eavesdropping or Leaking Authorization Codes',
    ],
    attackVector:
      'ATTACK: Authorization Code Interception\n\n' +
      '1. Attacker monitors network traffic or browser communication\n' +
      '2. User completes authorization flow, receives authorization code\n' +
      '3. Attacker intercepts the authorization code from the redirect URI\n' +
      '4. Without PKCE, attacker can exchange the code for access token\n' +
      '5. Attacker gains unauthorized access to protected resources\n\n' +
      'PREREQUISITES:\n' +
      '- Public client (no client secret)\n' +
      '- Ability to intercept redirect URI (malware, network sniffing)\n' +
      '- PKCE disabled\n\n' +
      'IMPACT: Complete account compromise, unauthorized access to all resources',
    mitigation:
      'DEFENSE: Enable PKCE (Proof Key for Code Exchange)\n\n' +
      '1. Generate cryptographically random code_verifier (43-128 chars)\n' +
      '2. Derive code_challenge = BASE64URL(SHA256(code_verifier))\n' +
      '3. Send code_challenge in authorization request\n' +
      '4. Send code_verifier in token request\n' +
      '5. Authorization server validates match\n\n' +
      'OAuth 2.1 REQUIREMENT: PKCE is REQUIRED for all authorization code flows\n\n' +
      'CONFIGURATION:\n' +
      '- Set usePKCE: true in client configuration\n' +
      '- Use S256 code challenge method (SHA-256)\n' +
      '- Ensure code_verifier has sufficient entropy (256+ bits)\n\n' +
      'BEST PRACTICES:\n' +
      '- Always use PKCE, even for confidential clients\n' +
      '- Never use "plain" code challenge method\n' +
      '- Validate PKCE parameters server-side',
    phase: 'mvp',
    implemented: true,
    demoScenario:
      'DEMONSTRATION SCENARIO:\n\n' +
      'STEP 1: Enable DISABLE_PKCE vulnerability toggle\n' +
      'STEP 2: Start authorization code flow\n' +
      'STEP 3: Observe authorization request without code_challenge parameter\n' +
      'STEP 4: Complete user authentication\n' +
      'STEP 5: Intercept authorization code from callback\n' +
      'STEP 6: Exchange code for tokens without code_verifier\n' +
      'STEP 7: Note that exchange succeeds (vulnerability demonstrated)\n\n' +
      'COMPARISON:\n' +
      'With PKCE: Token exchange fails without correct code_verifier\n' +
      'Without PKCE: Token exchange succeeds, code is vulnerable to interception',
  },

  // ========================================================================
  // Phase 2/3 toggles - Metadata will be added when implemented
  // ========================================================================
  // Note: Additional toggle metadata will be added as features are implemented
  // in Phase 2 and Phase 3. For now, only DISABLE_PKCE is fully documented
  // as it's the only toggle functional in MVP.
};
